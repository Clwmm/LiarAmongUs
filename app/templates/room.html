{% extends "base.html" %}

{% block title %}Room {{ room_id }}{% endblock %}

{% block content %}
<div class="fixed inset-0 bg-gray-900 text-white overflow-auto flex flex-col items-center py-10 px-4 space-y-5">
    <div class="w-full bg-gray-600 text-white font-semibold py-4 px-8 rounded-4xl text-6xl text-center">Room {{ room_id }}</div>

    <div id="header" class="flex gap-4 w-full mb-10">
      <div class="w-1/2 bg-gray-600 text-white font-semibold py-4 px-8 rounded-4xl text-6xl text-center">
          NAME
      </div>
      <div id="second-column" class="w-1/2 bg-gray-600 text-white font-semibold py-4 px-8 rounded-4xl text-6xl text-center">
          POINTS
      </div>
    </div>

    <div hidden id="revealed_answer" class="flex w-full h-1/3 mb-10 bg-red-700 text-9xl items-center justify-center rounded-4xl text-white font-semibold"></div>

    <div id="players-div" class="w-full space-y-5 mb-10"></div>

    <div hidden id="real-question-div" class="w-full bg-gray-600 text-white font-semibold py-4 px-8 rounded-4xl text-6xl text-center">Real question:</div>
    <div hidden id="real-question-text" class="w-full bg-gray-600 text-white font-semibold py-4 px-8 rounded-4xl text-6xl text-center"></div>

    <div hidden id="your-answer" class="w-full bg-gray-600 text-white font-semibold py-4 px-8 rounded-4xl text-6xl text-center">Your answer:</div>
    <div hidden id="your-vote" class="w-full bg-gray-600 text-white font-semibold py-4 px-8 rounded-4xl text-6xl text-center">Your vote:</div>

    <div hidden id="your-question-div" class="w-full bg-gray-600 text-white font-semibold py-4 px-8 rounded-4xl text-6xl text-center">Your question:</div>
    <button hidden
        id="your-question-toggle-button"
        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-4 px-8 rounded-4xl text-6xl transition duration-200">
        Show your question
    </button>
    <div hidden id="your-question-text" class="w-full bg-gray-600 text-white font-semibold py-4 px-8 rounded-4xl text-6xl text-center"></div>

    <button id="start-btn"
        class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-4 px-8 rounded-4xl text-6xl transition duration-200">
        Start Game
    </button>

    <button
        hidden
        id="submit-answer"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-8 rounded-4xl text-6xl transition duration-200">
        Submit Answer
    </button>

    <button
        hidden
        id="start-voting-button"
        class="w-full bg-pink-600 hover:bg-pink-700 text-white font-semibold py-4 px-8 rounded-4xl text-6xl transition duration-200">
        Start voting
    </button>

    <button
        hidden
        id="submit-vote"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-8 rounded-4xl text-6xl transition duration-200">
        Submit vote
    </button>

    <button
        hidden
        id="vote-again-button"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-8 rounded-4xl text-6xl transition duration-200">
        Vote again
    </button>

    <button
        hidden
        id="show-points-button"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-8 rounded-4xl text-6xl transition duration-200">
        Show points
    </button>

    <button
        hidden
        id="next-round-button"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-8 mt-50 rounded-4xl text-6xl transition duration-200">
        Next round
    </button>
</div>

<script>
    const roomId = "{{ room_id }}";
    const name = "{{ name }}";
    const startBtn = document.getElementById("start-btn");
    const playersDiv = document.getElementById("players-div");
    const second_column = document.getElementById("second-column");
    const yourQuestionDiv = document.getElementById("your-question-div");
    const yourQuestionText = document.getElementById("your-question-text");
    const realQuestionDiv = document.getElementById("real-question-div");
    const realQuestionText = document.getElementById("real-question-text");
    const submitAnswer = document.getElementById("submit-answer");
    const header = document.getElementById("header");
    const revealedAnswer = document.getElementById("revealed_answer");
    const yourAnswer = document.getElementById("your-answer");
    const yourVote = document.getElementById("your-vote");
    const yourQuestionToggleButton = document.getElementById("your-question-toggle-button");
    const startVotingButton = document.getElementById("start-voting-button");
    const submitVote = document.getElementById("submit-vote");
    const showPointsButton = document.getElementById("show-points-button");
    const voteAgainButton = document.getElementById("vote-again-button");
    const nextRoundButton = document.getElementById("next-round-button");
    let selectedAnswer = null;
    let answered = false;
    let selectedVote = null;
    let voted = false;

    function showHeader() {
        header.hidden = false;
    }
    function hideHeader() {
        header.hidden = true;
    }
    function showRevealedAnswer() {
        revealedAnswer.hidden = false;
    }
    function hideRevealedAnswer() {
        revealedAnswer.hidden = true;
    }
    function showPlayersList() {
        playersDiv.hidden = false;
    }
    function hidePlayersList() {
        playersDiv.hidden = true;
    }
    function showRealQuestion() {
        realQuestionDiv.hidden = false;
        realQuestionText.hidden = false;
    }
    function hideRealQuestion() {
        realQuestionDiv.hidden = true;
        realQuestionText.hidden = true;
    }
    function showYourAnswer() {
        yourAnswer.hidden = false;
    }
    function hideYourAnswer() {
        yourAnswer.hidden = true;
    }
    function showYourVote() {
        yourVote.hidden = false;
    }
    function hideYourVote() {
        yourVote.hidden = true;
    }
    function showYourQuestion() {
        yourQuestionDiv.hidden = false;
    }
    function hideYourQuestion() {
        yourQuestionDiv.hidden = true;
    }
    function showYourQuestionToggleButton() {
        yourQuestionToggleButton.hidden = false;
    }
    function hideYourQuestionToggleButton() {
        yourQuestionToggleButton.hidden = true;
    }
    function showYourQuestionText() {
        yourQuestionText.hidden = false;
    }
    function hideYourQuestionText() {
        yourQuestionText.hidden = true;
    }
    function showStartGameButton() {
        startBtn.hidden = false;
    }
    function hideStartGameButton() {
        startBtn.hidden = true;
    }
    function showSubmitAnswerButton() {
        submitAnswer.hidden = false;
    }
    function hideSubmitAnswerButton() {
        submitAnswer.hidden = true;
    }
    function showStartVotingButton() {
        startVotingButton.hidden = false;
    }
    function hideStartVotingButton() {
        startVotingButton.hidden = true;
    }
    function showSubmitVoteButton() {
        submitVote.hidden = false;
    }
    function hideSubmitVoteButton() {
        submitVote.hidden = true;
    }
    function showShowPointsButton() {
        showPointsButton.hidden = false;
    }
    function hideShowPointsButton() {
        showPointsButton.hidden = true;
    }
    function showVoteAgainButton() {
        voteAgainButton.hidden = false;
    }
    function hideVoteAgainButton() {
        voteAgainButton.hidden = true;
    }
    function showNextRoundButton() {
        nextRoundButton.hidden = false;
    }
    function hideNextRoundButton() {
        nextRoundButton.hidden = true;
    }



    const wsProtocol = location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(`${wsProtocol}://${location.host}/ws/${roomId}?name=${encodeURIComponent(name)}`);

    // ws.onopen = () => {
    //     // Send the initial action once the WebSocket is ready
    //     ws.send(JSON.stringify({
    //         action: "get_players"
    //     }));
    // };

    function setAnswerState(question, already_answered, answered_m) {
        showHeader();
        hideRevealedAnswer();
        showPlayersList();
        hideRealQuestion();
        hideYourAnswer();
        hideYourVote();
        showYourQuestion();
        hideYourQuestionToggleButton();
        showYourQuestionText();
        hideStartGameButton();
        if (already_answered)
            hideSubmitAnswerButton();
        else
            showSubmitAnswerButton();
        hideStartVotingButton();
        hideSubmitVoteButton();
        hideShowPointsButton();
        hideVoteAgainButton();
        hideNextRoundButton();

        yourQuestionText.textContent = question;
        if (already_answered) {
            answered = true;
            selectedAnswer = answered_m;
        }
        else
            selectedAnswer = null;
        second_column.textContent = "ANSWER";

        const playerRows = playersDiv.querySelectorAll("div.flex");
            playerRows.forEach(row => {
                let nameDiv = row.children[0];
                let secondDiv = row.children[1];
                let name = nameDiv.textContent.trim();

                if (nameDiv.classList.contains('text-red-600')) {
                  nameDiv.classList.remove('text-red-600');
                  nameDiv.classList.add('text-white');
                }

                const chooseBtn = document.createElement("button");
                chooseBtn.textContent = "CHOOSE";

                chooseBtn.className = "w-1/2 bg-green-800 hover:bg-red-700 text-white font-semibold py-4 px-8 rounded-4xl text-6xl transition duration-200";

                if (already_answered && answered_m === name) {
                    chooseBtn.classList.remove("bg-green-800");
                    chooseBtn.classList.add("bg-red-600");
                }

                chooseBtn.onclick = () => {
                    if (answered)
                        return;
                    // Deselect all buttons
                    playersDiv.querySelectorAll("button").forEach(btn => {
                        btn.classList.remove("bg-red-600");
                        btn.classList.add("bg-green-800");
                    });

                    // Select this one
                    chooseBtn.classList.remove("bg-green-800");
                    chooseBtn.classList.add("bg-red-600");

                    selectedAnswer = nameDiv.textContent.trim();
                };

                // Replace secondDiv with chooseBtn
                row.replaceChild(chooseBtn, secondDiv);
            });
    }

    function setDiscusionState(real_question) {
        hideHeader();
        showRevealedAnswer();
        hidePlayersList();
        showRealQuestion();
        hideYourAnswer();
        hideYourVote();
        hideYourQuestion();
        showYourQuestionToggleButton();
        hideYourQuestionText();
        hideStartGameButton();
        hideSubmitAnswerButton();
        showStartVotingButton();
        hideSubmitVoteButton();
        hideShowPointsButton();
        hideVoteAgainButton();
        hideNextRoundButton();

        answered = false;
        revealedAnswer.textContent = selectedAnswer;
        realQuestionText.textContent = real_question;
    }

    function setVotingState(already_voted, vote_m) {
        showHeader();
        hideRevealedAnswer();
        showPlayersList();
        showRealQuestion();
        showYourAnswer();
        hideYourVote();
        hideYourQuestion();
        showYourQuestionToggleButton();
        hideYourQuestionText();
        hideStartGameButton();
        hideSubmitAnswerButton();
        hideStartVotingButton();
        if (already_voted)
            hideSubmitVoteButton();
        else
            showSubmitVoteButton();
        hideShowPointsButton();
        hideVoteAgainButton();
        hideNextRoundButton();

        if (already_voted) {
            voted = true;
            selectedVote = vote_m;
        }
        else
            selectedVote = null;

        yourAnswer.textContent = "Your answer: " + selectedAnswer;
        second_column.textContent = "VOTE";

        const playerRows = playersDiv.querySelectorAll("div.flex");
            playerRows.forEach(row => {
                let nameDiv = row.children[0];
                let secondDiv = row.children[1];
                let name = nameDiv.textContent.trim();

                const chooseBtn = document.createElement("button");
                chooseBtn.textContent = "VOTE";
                chooseBtn.className = "w-1/2 bg-green-800 hover:bg-red-700 text-white font-semibold py-4 px-8 rounded-4xl text-6xl transition duration-200";

                if (already_voted && vote_m === name) {
                    chooseBtn.classList.remove("bg-green-800");
                    chooseBtn.classList.add("bg-red-600");
                }

                chooseBtn.onclick = () => {
                    if (voted)
                        return;
                    // Deselect all buttons
                    playersDiv.querySelectorAll("button").forEach(btn => {
                        btn.classList.remove("bg-red-600");
                        btn.classList.add("bg-green-800");
                    });

                    // Select this one
                    chooseBtn.classList.remove("bg-green-800");
                    chooseBtn.classList.add("bg-red-600");

                    selectedVote = nameDiv.textContent.trim();
                };

                // Replace secondDiv with chooseBtn
                row.replaceChild(chooseBtn, secondDiv);
            });
    }

    function setVotingResultState(votes, validVoting) {
        showHeader();
        hideRevealedAnswer();
        showPlayersList();
        showRealQuestion();
        showYourAnswer();
        showYourVote();
        hideYourQuestion();
        showYourQuestionToggleButton();
        hideYourQuestionText();
        hideStartGameButton();
        hideSubmitAnswerButton();
        hideStartVotingButton();
        hideSubmitVoteButton();
        hideShowPointsButton();
        hideVoteAgainButton();
        hideNextRoundButton();

        if (validVoting)
            showShowPointsButton();
        else
            showVoteAgainButton();

        voted = false;
        yourVote.textContent = "Your vote: " + selectedVote;
        second_column.textContent = "VOTES";

        const playerRows = playersDiv.querySelectorAll("div.flex");
            playerRows.forEach(row => {
                let nameDiv = row.children[0];
                let secondDiv = row.children[1];
                let name = nameDiv.textContent.trim();

                const pointsDiv = document.createElement("div");
                pointsDiv.className = "w-1/2 bg-gray-800 text-white font-semibold py-4 px-8 rounded-4xl text-6xl text-center";

                // Check if name exists in the votes object
                if (votes.hasOwnProperty(name)) {
                    pointsDiv.textContent = votes[name];
                } else {
                    pointsDiv.textContent = 0;
                }

                // Replace secondDiv with chooseBtn
                row.replaceChild(pointsDiv, secondDiv);
            });
    }

    function setShowingPointsState(points, liar, diff) {
        showHeader();
        hideRevealedAnswer();
        showPlayersList();
        showRealQuestion();
        showYourAnswer();
        showYourVote();
        hideYourQuestion();
        showYourQuestionToggleButton();
        hideYourQuestionText();
        hideStartGameButton();
        hideSubmitAnswerButton();
        hideStartVotingButton();
        hideSubmitVoteButton();
        hideShowPointsButton();
        hideVoteAgainButton();
        showNextRoundButton();

        second_column.textContent = "POINTS";

        const playerRows = playersDiv.querySelectorAll("div.flex");
            playerRows.forEach(row => {
                let nameDiv = row.children[0];
                let secondDiv = row.children[1];
                let name = nameDiv.textContent.trim();

                const pointsDiv = document.createElement("div");
                pointsDiv.className = "w-1/2 bg-gray-800 text-white font-semibold py-4 px-8 rounded-4xl text-6xl text-center";

                // Check if name exists in the points object
                let points_text = "";
                if (points.hasOwnProperty(name)) {
                    points_text = points[name];
                } else {
                    points_text = "0";
                }

                if (diff[name] !== 0)
                    pointsDiv.textContent = points_text + " (+" + diff[name] + ")";
                else
                    pointsDiv.textContent = points_text;

                if (name === liar) {
                    nameDiv.classList.remove("text-white")
                    nameDiv.classList.add("text-red-600")
                }

                // Replace secondDiv with chooseBtn
                row.replaceChild(pointsDiv, secondDiv);
            });
    }

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.players) {
            playersDiv.innerHTML = "";
            data.players.forEach(player => {
                const rowDiv = document.createElement("div");
                rowDiv.className = "flex gap-4 w-full";

                const nameDiv = document.createElement("div");
                nameDiv.className = "w-1/2 bg-gray-800 text-white font-semibold py-4 px-8 rounded-4xl text-6xl text-center";
                nameDiv.textContent = player;

                const pointsDiv = document.createElement("div");
                pointsDiv.className = "w-1/2 bg-gray-800 text-white font-semibold py-4 px-8 rounded-4xl text-6xl text-center";
                pointsDiv.textContent = 0;

                rowDiv.appendChild(nameDiv);
                rowDiv.appendChild(pointsDiv);
                playersDiv.appendChild(rowDiv);
            });
        }

        if (data.action === "redirect") {
            window.location.href = data.target || "/";
        }

        if (data.action === "ping_start_game") {
            ws.send(JSON.stringify({
                action: "pong_start_game",
                name: name
            }));
        }

        if (data.action === "start_game") {
            setAnswerState(data.question, false);
        }

        if (data.action === "answers_submitted") {
            setDiscusionState(data.real_question);
        }

        if (data.action === "start_voting") {
            setVotingState();
        }

        if (data.action === "show_points") {
            setShowingPointsState(data.points, data.liar, data.diff);
        }

        if (data.action === "votes_submitted") {
            setVotingResultState(data.votes, data.validVoting);
        }

        if (data.action === "state") {
            switch (data.state) {
                case "ANSWER":
                    setAnswerState(data.your_question, data.already_answered, data.your_answer);
                    break;
                case "DISCUSSION":
                    setAnswerState(data.your_question, data.already_answered, data.your_answer);
                    setDiscusionState(data.real_question);
                    break;
                case "VOTING":
                    setAnswerState(data.your_question, data.already_answered, data.your_answer);
                    setDiscusionState(data.real_question);
                    setVotingState(data.already_voted, data.your_vote);
                    break;
                case "VOTING_RESULTS":
                    setAnswerState(data.your_question, data.already_answered, data.your_answer);
                    setDiscusionState(data.real_question);
                    setVotingState(data.already_voted, data.your_vote);
                    setVotingResultState(data.votes_count, data.valid_voting);
                    break;
                case "VOTE_AGAIN":
                    setAnswerState(data.your_question, data.already_answered, data.your_answer);
                    setDiscusionState(data.real_question);
                    setVotingState(data.already_voted, data.your_vote);
                    setVotingResultState(data.votes_count, data.valid_voting);
                    break;
                case "POINTS":
                    setAnswerState(data.your_question, data.already_answered, data.your_answer);
                    setDiscusionState(data.real_question);
                    setVotingState(data.already_voted, data.your_vote);
                    setVotingResultState(data.votes_count, data.valid_voting);
                    setShowingPointsState(data.points, data.liar, data.diff);
                    break;
                default:
                    const alert_m = "Not implemented: " + data.state;
                    alert(alert_m);
            }
        }
    };

    startBtn.onclick = async () => {
        const res = await fetch(`/start_game/${roomId}`, {
            method: "POST"
        });
        const result = await res.json();
        if (result.error) {
            alert(result.error);
        }
    };

    submitAnswer.onclick = () => {
        if (!selectedAnswer) {
            alert("Please choose a player before submitting.");
            return;
        }

        ws.send(JSON.stringify({
            action: "submit_answer",
            name: name,
            answer: selectedAnswer
        }));

        answered = true;
        submitAnswer.hidden = true;
    };

    submitVote.onclick = () => {
        if (!selectedVote) {
            alert("Please vote a player before submitting.")
            return;
        }

        ws.send(JSON.stringify({
            action: "submit_vote",
            voter: name,
            target: selectedVote
        }));

        voted = true;
        submitVote.hidden = true;
    };

    yourQuestionToggleButton.onclick = () => {
        yourQuestionText.hidden = !yourQuestionText.hidden;
    };

    startVotingButton.onclick = () => {
        ws.send(JSON.stringify({
            action: "start_voting_request"
        }));
    };

    showPointsButton.onclick = () => {
        ws.send(JSON.stringify({
            action: "show_points_request"
        }));
    };

    nextRoundButton.onclick = () => {
        ws.send(JSON.stringify({
            action: "next_round_request"
        }));
    };

    voteAgainButton.onclick = () => {
        ws.send(JSON.stringify({
            action: "vote_again_request"
        }));
    };
</script>
{% endblock %}
