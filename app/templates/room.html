{% extends "base.html" %}

{% block title %}Room {{ room_id }}{% endblock %}

{% block content %}
<div class="fixed inset-0 bg-gray-900 text-white overflow-auto flex flex-col items-center py-10 px-4 space-y-5">
    <div
        class="w-full bg-gray-600 text-white font-semibold py-4 px-8 rounded-4xl text-6xl text-center">
        Room {{ room_id }}
    </div>

    <div hidden id="revealed_answer" class="flex w-full h-1/3 mb-10 bg-red-700 text-8xl items-center justify-center rounded-4xl text-white font-semibold"></div>

    <div id="header" class="flex gap-4 w-full mb-10">
      <div class="w-1/2 bg-gray-600 text-white font-semibold py-4 px-8 rounded-4xl text-6xl text-center">
          NAME
      </div>
      <div id="second-column" class="w-1/2 bg-gray-600 text-white font-semibold py-4 px-8 rounded-4xl text-6xl text-center">
          POINTS
      </div>
    </div>

    <div id="players-div" class="w-full space-y-5 mb-10"></div>

    <button id="start-btn"
        class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-4 px-8 rounded-4xl text-6xl transition duration-200">
        Start Game
    </button>

    <div hidden id="real-question-div" class="w-full space-y-5"></div>

    <div hidden id="your-question-div" class="w-full space-y-5"></div>

    <button
        hidden
        id="submit-answer"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-8 rounded-4xl text-6xl transition duration-200">
        Submit Answer
    </button>
</div>

<script>
    const roomId = "{{ room_id }}";
    const name = "{{ name }}";
    const startBtn = document.getElementById("start-btn");
    const playersDiv = document.getElementById("players-div");
    const second_column = document.getElementById("second-column");
    const yourQuestionDiv = document.getElementById("your-question-div");
    const realQuestionDiv = document.getElementById("real-question-div");
    const submitAnswer = document.getElementById("submit-answer");
    const header = document.getElementById("header");
    const revealedAnswer = document.getElementById("revealed_answer");
    let selectedAnswer = null;

    const wsProtocol = location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(`${wsProtocol}://${location.host}/ws/${roomId}`);

    // ws.onopen = () => {
    //     // Send the initial action once the WebSocket is ready
    //     ws.send(JSON.stringify({
    //         action: "get_players"
    //     }));
    // };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.action === "redirect") {
            window.location.href = data.target || "/";
        }

        if (data.action === "start_game") {
            second_column.innerHTML = "ANSWER";
            startBtn.classList.add("hidden");

            submitAnswer.hidden = false;

            yourQuestionDiv.innerHTML = "";
            yourQuestionDiv.hidden = false;
            const yourQuestion = document.createElement("div");
            yourQuestion.className = "w-full bg-gray-600 text-white font-semibold py-4 px-8 rounded-4xl text-6xl text-center";
            yourQuestion.innerHTML = "Your question:";

            const question = document.createElement("div");
            question.className = "w-full bg-gray-600 text-white font-semibold py-4 px-8 rounded-4xl text-6xl text-center";
            question.innerHTML = data.question;

            yourQuestionDiv.appendChild(yourQuestion);
            yourQuestionDiv.appendChild(question);

            selectedAnswer = null;

            const playerRows = playersDiv.querySelectorAll("div.flex");
            playerRows.forEach(row => {
                let nameDiv = row.children[0];
                let secondDiv = row.children[1];
                console.log("second div:");
                console.log(secondDiv);

                const chooseBtn = document.createElement("button");
                chooseBtn.textContent = "CHOOSE";
                chooseBtn.className = "w-1/2 bg-green-800 hover:bg-red-700 text-white font-semibold py-4 px-8 rounded-4xl text-6xl transition duration-200";

                chooseBtn.onclick = () => {
                    // Deselect all buttons
                    playersDiv.querySelectorAll("button").forEach(btn => {
                        btn.classList.remove("bg-red-600");
                        btn.classList.add("bg-green-800");
                    });

                    // Select this one
                    chooseBtn.classList.remove("bg-green-800");
                    chooseBtn.classList.add("bg-red-600");

                    selectedAnswer = nameDiv.textContent.trim();
                };

                // Replace secondDiv with chooseBtn
                row.replaceChild(chooseBtn, secondDiv);
            });
        }

        if (data.action === "reveal_votes") {
            const votes = data.votes;
            let voteText = "🗳️ Voting results:\n\n";
            for (const [voter, target] of Object.entries(votes)) {
                voteText += `${voter} ➡️ ${target}\n`;
            }
            alert(voteText);
        }

        if (data.action === "answers_submitted") {
            header.hidden = true;
            playersDiv.hidden = true;
            revealedAnswer.hidden = false;

            revealedAnswer.textContent = selectedAnswer;

            realQuestionDiv.innerHTML = "";
            realQuestionDiv.hidden = false;
            const yourQuestion = document.createElement("div");
            yourQuestion.className = "w-full bg-gray-600 text-white font-semibold py-4 px-8 rounded-4xl text-6xl text-center";
            yourQuestion.innerHTML = "Real question:";

            const question = document.createElement("div");
            question.className = "w-full bg-gray-600 text-white font-semibold py-4 px-8 rounded-4xl text-6xl text-center";
            question.innerHTML = data.real_question;

            realQuestionDiv.appendChild(yourQuestion);
            realQuestionDiv.appendChild(question);
        }

        if (data.players) {
            playersDiv.innerHTML = "";
            data.players.forEach(player => {
                const rowDiv = document.createElement("div");
                rowDiv.className = "flex gap-4 w-full";

                const nameDiv = document.createElement("div");
                nameDiv.className = "w-1/2 bg-gray-800 text-white font-semibold py-4 px-8 rounded-4xl text-6xl text-center";
                nameDiv.textContent = player;

                const pointsDiv = document.createElement("div");
                pointsDiv.className = "w-1/2 bg-gray-800 text-white font-semibold py-4 px-8 rounded-4xl text-6xl text-center";
                pointsDiv.textContent = 0;

                rowDiv.appendChild(nameDiv);
                rowDiv.appendChild(pointsDiv);
                playersDiv.appendChild(rowDiv);
            });

        }
    };

    startBtn.onclick = async () => {
        const res = await fetch(`/start_game/${roomId}`, {
            method: "POST"
        });
        const result = await res.json();
        if (result.error) {
            alert(result.error);
        }
    };

    submitAnswer.onclick = () => {
        if (!selectedAnswer) {
            alert("Please choose a player before submitting.");
            return;
        }

        ws.send(JSON.stringify({
            action: "submit_answer",
            voter: name,
            target: selectedAnswer
        }));

        // Optional: disable submit button or hide to prevent multiple votes
        submitAnswer.hidden = true;
    };
</script>
{% endblock %}
