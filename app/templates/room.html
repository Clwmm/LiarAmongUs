{% extends "base.html" %}

{% block title %}Room {{ room_id }}{% endblock %}

{% block content %}
    <h2>Room {{ room_id }}</h2>
    <h3>Players:</h3>
    <div id="player-buttons" style="display: flex; flex-wrap: wrap; gap: 10px;">
        {% for player in players %}
            <li>{{ player }}</li>
        {% endfor %}
    </div>
    <button id="start-btn" style="margin-top: 1rem;">Start Game</button>
    <p id="your-question" style="margin-top: 2rem; font-weight: bold;"></p>


    <script>
        const roomId = "{{ room_id }}";
        const name = "{{ name }}";
        const playerButtons = document.getElementById("player-buttons");
        let hasVoted = false;
        const startBtn = document.getElementById("start-btn");
        const questionText = document.getElementById("your-question");

        const wsProtocol = location.protocol === "https:" ? "wss" : "ws";
        const ws = new WebSocket(`${wsProtocol}://${location.host}/ws/${roomId}`);

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.action === "redirect") {
                window.location.href = data.target || "/";
            }

            if (data.action === "start_game") {
                questionText.innerText = "Your question: " + data.question;
                startBtn.style.display = "none";
                hasVoted = false;
            }

            if (data.players) {
                playerButtons.innerHTML = "";
                data.players.forEach(player => {
                    const btn = document.createElement("button");
                    btn.textContent = player;
                    btn.style.padding = "10px";
                    btn.style.minWidth = "100px";
                    btn.style.border = "2px solid gray";
                    btn.style.borderRadius = "6px";
                    btn.style.background = "#222";
                    btn.style.color = "white";

                    btn.onclick = () => {
                        if (hasVoted) return;

                        // Highlight selection
                        document.querySelectorAll("#player-buttons button").forEach(b => {
                            b.style.borderColor = "gray";
                        });
                        btn.style.borderColor = "limegreen";

                        // Send vote
                        ws.send(JSON.stringify({
                            action: "vote",
                            voter: name,
                            target: player
                        }));
                        hasVoted = true;
                    };

                    playerButtons.appendChild(btn);
                });
            }

            if (data.action === "reveal_votes") {
                const votes = data.votes;
                let voteText = "🗳️ Voting results:\n\n";
                for (const [voter, target] of Object.entries(votes)) {
                    voteText += `${voter} ➡️ ${target}\n`;
                }
                alert(voteText);
            }
        };

        startBtn.onclick = async () => {
            const res = await fetch(`/start_game/${roomId}`, {
                method: "POST"
            });
            const result = await res.json();
            if (result.error) {
                alert(result.error);
            }
        };
    </script>

{% endblock %}
